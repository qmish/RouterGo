<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <title>RouterGo Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; background: #f6f7fb; color: #1d1f23; }
      h1 { margin-bottom: 6px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
      .gridWide { grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); }
      .card { background: #fff; border-radius: 10px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
      .meta { font-size: 12px; color: #6b7280; }
      .alerts { max-height: 220px; overflow: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 12px; }
      th, td { padding: 6px; border-bottom: 1px solid #eee; text-align: left; }
      .badge { display: inline-block; padding: 2px 6px; border-radius: 6px; font-size: 11px; background: #eef2ff; color: #3730a3; }
      .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background:#f3f4f6; font-size: 12px; margin-right: 6px; }
      .nav { display:flex; gap:8px; flex-wrap: wrap; margin: 8px 0; }
      .nav button { padding: 6px 10px; border-radius: 8px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
      .nav button.active { background:#eef2ff; border-color:#c7d2fe; }
      .hidden { display: none; }
      .preset-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
      .preset-card { background:#fff; border-radius: 10px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
      .preset-icon { font-size: 28px; }
      .preset-actions { display:flex; gap:8px; margin-top: 8px; }
      .preset-summary table { font-size: 12px; }
      .form-row { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; margin-top: 8px; }
      .form-actions { margin-top: 8px; display:flex; gap:8px; flex-wrap: wrap; }
      .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 6px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; }
      .muted { font-size: 12px; color: #6b7280; }
      .settings-section { margin-top: 8px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div style="display:flex; align-items:center; gap:12px; flex-wrap: wrap;">
      <h1 style="margin-right:auto;">RouterGo Dashboard</h1>
      <button id="openPresetsBtn">Настроить по шаблону</button>
    </div>
    <div class="meta">Автообновление</div>
    <div class="nav">
      <button data-tab="overview">Обзор</button>
      <button data-tab="traffic">Трафик</button>
      <button data-tab="sessions">Сессии</button>
      <button data-tab="alerts">Алерты</button>
      <button data-tab="settings">Настройки</button>
      <button data-tab="presets">Пресеты</button>
    </div>
    <div style="margin: 10px 0; display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
      <button id="refreshBtn">Обновить сейчас</button>
      <label>
        <input type="checkbox" id="demoMode"> Демо-данные
      </label>
      <label>
        Интервал:
        <select id="refreshInterval">
          <option value="2000">2с</option>
          <option value="5000" selected>5с</option>
          <option value="10000">10с</option>
        </select>
      </label>
      <label>
        Фильтр src:
        <select id="srcFilter">
          <option value="">Все</option>
        </select>
      </label>
    </div>
    <div id="tab-overview" class="grid gridWide" style="margin-top: 12px;">
      <div class="card">
        <h3>Система</h3>
        <div id="sysStats">
          <span class="pill">packets: -</span>
          <span class="pill">rx: -</span>
          <span class="pill">tx: -</span>
          <span class="pill">drops: -</span>
          <span class="pill">errors: -</span>
        </div>
        <div class="meta" style="margin-top:8px;">/api/stats</div>
      </div>
      <div class="card">
        <h3>Подсистемы</h3>
        <div id="subsystemStats">
          <div class="pill">IDS alerts: -</div>
          <div class="pill">P2P peers: -</div>
          <div class="pill">Proxy hits: -</div>
        </div>
      </div>
      <div class="card">
        <h3>Proxy</h3>
        <div id="proxyStats">
          <span class="pill">hits: -</span>
          <span class="pill">miss: -</span>
          <span class="pill">compress: -</span>
          <span class="pill">size: -</span>
        </div>
      </div>
      <div class="card">
        <h3>Enrich</h3>
        <div id="enrichInfo" class="meta">Выберите src для обогащения</div>
      </div>
    </div>

    <div id="tab-traffic" class="grid" style="margin-top: 12px;">
      <div class="card">
        <h3>Top bandwidth (src IP)</h3>
        <canvas id="topChart" height="140"></canvas>
      </div>
      <div class="card">
        <h3>История трафика (top src)</h3>
        <canvas id="historyChart" height="140"></canvas>
      </div>
    </div>

    <div id="tab-sessions" class="grid" style="margin-top: 12px;">
      <div class="card">
        <h3>Sessions tree</h3>
        <div class="meta">Суммарные байты по направлению</div>
        <table id="sessionsTable">
          <thead>
            <tr><th>Src</th><th>Dst</th><th>Bytes</th><th>Packets</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="tab-alerts" class="grid" style="margin-top: 12px;">
      <div class="card">
        <h3>Alerts</h3>
        <div class="meta">Фильтры</div>
        <div style="margin: 6px 0;">
          <label>Тип:
            <select id="alertType">
              <option value="">Все</option>
              <option value="SIGNATURE">SIGNATURE</option>
              <option value="RATE_SPIKE">RATE_SPIKE</option>
              <option value="PORT_SCAN">PORT_SCAN</option>
              <option value="DST_SWEEP">DST_SWEEP</option>
            </select>
          </label>
        </div>
        <div class="alerts" id="alerts"></div>
      </div>
    </div>

    <div id="tab-settings" class="grid gridWide hidden" style="margin-top: 12px;">
      <div class="card">
        <h3>Интерфейсы</h3>
        <div class="meta">/settings/interfaces</div>
        <table id="interfacesTable">
          <thead>
            <tr><th>Имя</th><th>IP/CIDR</th><th>Состояние</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="muted settings-section">Управление интерфейсами в разработке.</div>
      </div>

      <div class="card">
        <h3>Маршрутизация</h3>
        <div class="meta">/settings/routing</div>
        <table id="routesTable">
          <thead>
            <tr><th>Destination</th><th>Gateway</th><th>Interface</th><th>Metric</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="form-row">
          <input id="routeDestination" placeholder="destination (CIDR)">
          <input id="routeGateway" placeholder="gateway (IP)">
          <input id="routeInterface" placeholder="interface">
          <input id="routeMetric" placeholder="metric" type="number" min="0">
        </div>
        <div class="form-actions">
          <button id="addRouteBtn">Добавить маршрут</button>
          <button id="updateRouteBtn" disabled>Обновить маршрут</button>
          <button id="cancelRouteEditBtn" disabled>Отмена</button>
        </div>
      </div>

      <div class="card">
        <h3>Firewall</h3>
        <div class="meta">/settings/firewall</div>
        <table id="firewallTable">
          <thead>
            <tr><th>Chain</th><th>Action</th><th>Protocol</th><th>Src</th><th>Dst</th><th>Ports</th><th>IF</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="form-row">
          <select id="fwChain">
            <option value="INPUT">INPUT</option>
            <option value="OUTPUT">OUTPUT</option>
            <option value="FORWARD">FORWARD</option>
          </select>
          <select id="fwAction">
            <option value="ACCEPT">ACCEPT</option>
            <option value="DROP">DROP</option>
            <option value="REJECT">REJECT</option>
          </select>
          <input id="fwProtocol" placeholder="protocol (TCP/UDP/ICMP)">
          <input id="fwSrcIP" placeholder="src_ip (CIDR)">
          <input id="fwDstIP" placeholder="dst_ip (CIDR)">
          <input id="fwSrcPort" placeholder="src_port" type="number" min="0" max="65535">
          <input id="fwDstPort" placeholder="dst_port" type="number" min="0" max="65535">
          <input id="fwInIface" placeholder="in_interface">
          <input id="fwOutIface" placeholder="out_interface">
        </div>
        <div class="form-actions">
          <button id="addFirewallBtn">Добавить правило</button>
          <button id="updateFirewallBtn" disabled>Обновить правило</button>
          <button id="cancelFirewallEditBtn" disabled>Отмена</button>
        </div>
        <div class="settings-section">
          <div class="muted">Default policy:</div>
          <div class="form-row">
            <select id="fwDefaultChain">
              <option value="INPUT">INPUT</option>
              <option value="OUTPUT">OUTPUT</option>
              <option value="FORWARD">FORWARD</option>
            </select>
            <select id="fwDefaultAction">
              <option value="ACCEPT">ACCEPT</option>
              <option value="DROP">DROP</option>
              <option value="REJECT">REJECT</option>
            </select>
          </div>
          <div class="form-actions">
            <button id="setFirewallDefaultBtn">Установить default</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>NAT</h3>
        <div class="meta">/settings/nat</div>
        <table id="natTable">
          <thead>
            <tr><th>Type</th><th>Src</th><th>Dst</th><th>Ports</th><th>To</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="form-row">
          <select id="natType">
            <option value="SNAT">SNAT</option>
            <option value="DNAT">DNAT</option>
          </select>
          <input id="natSrcIP" placeholder="src_ip (CIDR)">
          <input id="natDstIP" placeholder="dst_ip (CIDR)">
          <input id="natSrcPort" placeholder="src_port" type="number" min="0" max="65535">
          <input id="natDstPort" placeholder="dst_port" type="number" min="0" max="65535">
          <input id="natToIP" placeholder="to_ip (IP)">
          <input id="natToPort" placeholder="to_port" type="number" min="0" max="65535">
        </div>
        <div class="form-actions">
          <button id="addNATBtn">Добавить правило</button>
          <button id="updateNATBtn" disabled>Обновить правило</button>
          <button id="cancelNATEditBtn" disabled>Отмена</button>
        </div>
      </div>

      <div class="card">
        <h3>QoS</h3>
        <div class="meta">/settings/qos</div>
        <table id="qosTable">
          <thead>
            <tr><th>Name</th><th>Protocol</th><th>Ports</th><th>Rate</th><th>Priority</th><th>Queue</th><th>Drop</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="form-row">
          <input id="qosName" placeholder="name">
          <input id="qosProtocol" placeholder="protocol">
          <input id="qosSrcPort" placeholder="src_port" type="number" min="0" max="65535">
          <input id="qosDstPort" placeholder="dst_port" type="number" min="0" max="65535">
          <input id="qosRate" placeholder="rate_limit_kbps" type="number" min="0">
          <input id="qosPriority" placeholder="priority" type="number" min="0">
          <input id="qosMaxQueue" placeholder="max_queue" type="number" min="0">
          <input id="qosDropPolicy" placeholder="drop_policy (head/tail)">
        </div>
        <div class="form-actions">
          <button id="addQoSBtn">Добавить класс</button>
          <button id="updateQoSBtn" disabled>Обновить класс</button>
          <button id="cancelQoSEditBtn" disabled>Отмена</button>
        </div>
      </div>

      <div class="card">
        <h3>VPN</h3>
        <div class="meta">/settings/vpn</div>
        <div class="muted">Списки туннелей, ключи, статусы, маршруты.</div>
        <div class="muted settings-section">В разработке.</div>
      </div>

      <div class="card">
        <h3>DHCP</h3>
        <div class="meta">/settings/dhcp</div>
        <div class="muted">Пулы, резервации, статические записи.</div>
        <div class="muted settings-section">В разработке.</div>
      </div>

      <div class="card">
        <h3>Мониторинг и логи</h3>
        <div class="meta">/settings/monitoring</div>
        <div class="muted">Графики интерфейсов, логи firewall, NAT сессии.</div>
        <div class="muted settings-section">В разработке.</div>
      </div>

      <div class="card">
        <h3>Система и безопасность</h3>
        <div class="meta">/settings/system</div>
        <div class="muted">Обновления, бэкапы, пользователи, SSL/TLS, NTP.</div>
        <div class="muted settings-section">В разработке.</div>
      </div>

      <div class="card">
        <h3>API и интеграции</h3>
        <div class="meta">/settings/api</div>
        <div class="muted">API ключи, webhooks, экспорт конфигурации.</div>
        <div class="form-actions settings-section">
          <button id="exportConfigJsonBtn">Экспорт JSON</button>
          <button id="exportConfigYamlBtn">Экспорт YAML</button>
        </div>
        <div class="muted settings-section">Остальные функции в разработке.</div>
      </div>
    </div>

    <div id="tab-presets" class="grid gridWide" style="margin-top: 12px;">
      <div class="card">
        <h3>Быстрая настройка → Пресеты</h3>
        <div class="meta">Выберите профиль и посмотрите сводку изменений.</div>
        <div style="margin:8px 0; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="updatePresetsBtn">Проверить обновления</button>
        </div>
        <div id="presetsGrid" class="preset-grid" style="margin-top: 10px;"></div>
      </div>
      <div class="card">
        <h3>Сводка пресета</h3>
        <div id="presetDetail" class="meta">Выберите пресет</div>
      </div>
      <div class="card">
        <h3>Импорт пресетов</h3>
        <div class="meta">Вставьте JSON массива пресетов</div>
        <textarea id="presetsImport" style="width:100%; min-height:120px;"></textarea>
        <div style="margin-top:8px;">
          <button id="importPresetsBtn">Импортировать</button>
        </div>
      </div>
    </div>

    <script>
      const topCtx = document.getElementById('topChart');
      const historyCtx = document.getElementById('historyChart');
      let topChart = new Chart(topCtx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Bytes', data: [], backgroundColor: '#3b82f6' }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
      let historyChart = new Chart(historyCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Bytes', data: [], borderColor: '#10b981', fill: false, tension: 0.2 }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      let history = [];
      let refreshTimer = null;
      const storageKey = 'routergo_ui';
      let presetsList = [];
      let selectedPresetId = '';
      let lastPresetPreview = null;

      function demoTop() {
        const labels = Array.from({length: 8}, (_, i) => `10.0.0.${i+1}`);
        return labels.map((l, i) => ({ src_ip: l, bytes: (8 - i) * 1000 + Math.floor(Math.random()*800) }));
      }

      function demoSessions() {
        const data = {};
        for (let s = 1; s <= 4; s++) {
          const src = `10.0.0.${s}`;
          data[src] = [];
          for (let d = 1; d <= 3; d++) {
            data[src].push({ dst_ip: `1.1.1.${d}`, bytes: Math.floor(Math.random()*5000), packets: Math.floor(Math.random()*50) });
          }
        }
        return data;
      }

      function demoAlerts() {
        const now = new Date().toISOString();
        return [
          { type: 'PORT_SCAN', src_ip: '10.0.0.5', dst_ip: '1.1.1.1', reason: 'port_scan', protocol: 'TCP', timestamp: now },
          { type: 'RATE_SPIKE', src_ip: '10.0.0.8', dst_ip: '8.8.8.8', reason: 'rate_threshold', protocol: 'UDP', timestamp: now }
        ];
      }

      async function loadTop() {
        if (document.getElementById('demoMode').checked) {
          return demoTop();
        }
        const res = await fetch('/api/dashboard/top/bandwidth?limit=10');
        const data = await res.json();
        return data.length ? data : demoTop();
      }

      async function loadSessions() {
        if (document.getElementById('demoMode').checked) {
          return demoSessions();
        }
        const res = await fetch('/api/dashboard/sessions/tree');
        const data = await res.json();
        return Object.keys(data).length ? data : demoSessions();
      }

      async function loadAlerts() {
        if (document.getElementById('demoMode').checked) {
          return demoAlerts();
        }
        const type = document.getElementById('alertType').value;
        const url = type ? `/api/dashboard/alerts?type=${encodeURIComponent(type)}` : '/api/dashboard/alerts';
        const res = await fetch(url);
        const data = await res.json();
        return Array.isArray(data) && data.length ? data : demoAlerts();
      }

      async function loadStats() {
        const res = await fetch('/api/stats');
        if (!res.ok) {
          return null;
        }
        return res.json();
      }

      async function loadPresets() {
        const res = await fetch('/api/presets');
        if (!res.ok) {
          return [];
        }
        return res.json();
      }

      function buildOverridesPayload() {
        const ifaceName = document.getElementById('presetInterfaceName')?.value.trim();
        const ifaceIP = document.getElementById('presetInterfaceIP')?.value.trim();
        const gateway = document.getElementById('presetGateway')?.value.trim();
        const overrides = {};
        if (ifaceName) {
          overrides.interface_name = ifaceName;
        }
        if (ifaceIP) {
          overrides.interface_ip = ifaceIP;
        }
        if (gateway) {
          overrides.default_gateway = gateway;
        }
        return Object.keys(overrides).length ? { overrides } : {};
      }

      async function previewPreset(id) {
        const payload = buildOverridesPayload();
        const res = await fetch(`/api/presets/${encodeURIComponent(id)}/preview`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Не удалось получить сводку');
        }
        return res.json();
      }

      async function applyPreset(id) {
        const payload = buildOverridesPayload();
        const res = await fetch(`/api/presets/${encodeURIComponent(id)}/apply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Не удалось применить пресет');
        }
        return res.json();
      }

      async function savePreset(preset) {
        const res = await fetch('/api/presets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Не удалось сохранить пресет');
        }
        return res.json();
      }

      async function importPresets(raw) {
        const res = await fetch('/api/presets/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: raw
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Не удалось импортировать пресеты');
        }
        return res.json();
      }

      async function updatePresets() {
        const res = await fetch('/api/presets/update', { method: 'POST' });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Не удалось обновить пресеты');
        }
        return res.json();
      }

      async function loadProxyStats() {
        const res = await fetch('/api/proxy/stats');
        if (!res.ok) {
          return null;
        }
        return res.json();
      }

      async function loadEnrich(ip) {
        if (!ip) {
          return null;
        }
        const res = await fetch(`/api/enrich/ip?ip=${encodeURIComponent(ip)}`);
        if (!res.ok) {
          return null;
        }
        return res.json();
      }

      function renderTop(data) {
        topChart.data.labels = data.map(x => x.src_ip);
        topChart.data.datasets[0].data = data.map(x => x.bytes);
        topChart.update();
      }

      function renderHistory(topData) {
        if (!topData.length) {
          return;
        }
        const top = topData[0];
        const now = new Date().toLocaleTimeString();
        history.push({ t: now, v: top.bytes, src: top.src_ip });
        if (history.length > 30) {
          history = history.slice(-30);
        }
        historyChart.data.labels = history.map(h => h.t);
        historyChart.data.datasets[0].data = history.map(h => h.v);
        historyChart.update();
      }

      function renderSessions(data) {
        const rows = [];
        const filter = document.getElementById('srcFilter').value;
        Object.keys(data).forEach(src => {
          if (filter && src !== filter) {
            return;
          }
          data[src].forEach(dst => {
            rows.push({ src, dst: dst.dst_ip, bytes: dst.bytes, packets: dst.packets });
          });
        });
        rows.sort((a, b) => b.bytes - a.bytes);
        const tbody = document.querySelector('#sessionsTable tbody');
        tbody.innerHTML = rows.slice(0, 20).map(r =>
          `<tr><td>${r.src}</td><td>${r.dst}</td><td>${r.bytes}</td><td>${r.packets}</td></tr>`
        ).join('');
      }

      function renderAlerts(data) {
        const container = document.getElementById('alerts');
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<div class="meta">Нет алертов</div>';
          return;
        }
        container.innerHTML = data.slice(-50).reverse().map(a =>
          `<div style="margin-bottom:8px;">
            <span class="badge">${a.type || 'ALERT'}</span>
            <strong>${a.src_ip || '-'}</strong> → <strong>${a.dst_ip || '-'}</strong>
            <div class="meta">${a.reason || ''} ${a.protocol || ''} ${a.timestamp || ''}</div>
          </div>`
        ).join('');
      }

      function renderStats(stats) {
        if (!stats || stats.status !== 'ok') {
          return;
        }
        document.getElementById('sysStats').innerHTML = `
          <span class="pill">packets: ${stats.packets_total}</span>
          <span class="pill">rx: ${stats.rx_packets_total}</span>
          <span class="pill">tx: ${stats.tx_packets_total}</span>
          <span class="pill">drops: ${stats.drops_total}</span>
          <span class="pill">errors: ${stats.errors_total}</span>
        `;
        document.getElementById('subsystemStats').innerHTML = `
          <div class="pill">IDS alerts: ${stats.ids_alerts_total}</div>
          <div class="pill">P2P peers: ${stats.p2p_peers_total}</div>
          <div class="pill">Proxy hits: ${stats.proxy_cache_hits_total}</div>
        `;
      }

      function renderProxyStats(stats) {
        if (!stats) {
          return;
        }
        document.getElementById('proxyStats').innerHTML = `
          <span class="pill">hits: ${stats.cache_hits}</span>
          <span class="pill">miss: ${stats.cache_miss}</span>
          <span class="pill">compress: ${stats.compress_total}</span>
          <span class="pill">size: ${stats.cache_size}</span>
        `;
      }

      function renderEnrich(data) {
        const container = document.getElementById('enrichInfo');
        if (!data) {
          container.innerHTML = 'Нет данных';
          return;
        }
        const geo = data.geo ? `${data.geo.country || ''} ${data.geo.city || ''}`.trim() : '-';
        const asn = data.asn ? data.asn.asn || '-' : '-';
        const threat = data.threat ? data.threat.score : '-';
        container.innerHTML = `
          <div class="pill">IP: ${data.ip}</div>
          <div class="pill">Geo: ${geo || '-'}</div>
          <div class="pill">ASN: ${asn}</div>
          <div class="pill">Threat: ${threat}</div>
        `;
      }

      function updateFilterOptions(topData) {
        const select = document.getElementById('srcFilter');
        const current = select.value;
        const options = [''].concat(topData.map(x => x.src_ip));
        select.innerHTML = options.map(v => `<option value="${v}">${v || 'Все'}</option>`).join('');
        select.value = options.includes(current) ? current : '';
      }

      function renderPresets(list) {
        const grid = document.getElementById('presetsGrid');
        if (!Array.isArray(list) || list.length === 0) {
          grid.innerHTML = '<div class="meta">Пресеты не найдены</div>';
          return;
        }
        grid.innerHTML = list.map(p => `
          <div class="preset-card">
            <div class="preset-icon">${p.icon || '⚙️'}</div>
            <h3>${p.name}</h3>
            <div class="meta">${p.description || ''}</div>
            <div class="preset-actions">
              <button data-id="${p.id}" class="preset-preview">Сводка</button>
              <button data-id="${p.id}" class="preset-apply">Применить</button>
            </div>
          </div>
        `).join('');
        grid.querySelectorAll('.preset-preview').forEach(btn => {
          btn.addEventListener('click', () => showPresetSummary(btn.dataset.id));
        });
        grid.querySelectorAll('.preset-apply').forEach(btn => {
          btn.addEventListener('click', () => confirmApplyPreset(btn.dataset.id));
        });
      }

      function renderPresetDetail(preset, summary, error) {
        const detail = document.getElementById('presetDetail');
        if (error) {
          detail.innerHTML = `<div class="meta">${error}</div>`;
          return;
        }
        if (!preset || !summary) {
          detail.innerHTML = '<div class="meta">Выберите пресет</div>';
          return;
        }
        const extras = preset.extras || {};
        const extrasList = Object.keys(extras).map(k => `<div class="meta"><strong>${k}:</strong> ${Array.isArray(extras[k]) ? extras[k].join(', ') : extras[k]}</div>`).join('');
        detail.innerHTML = `
          <div><strong>${preset.name}</strong></div>
          <div class="meta">${preset.description || ''}</div>
          <div style="margin-top:8px;">
            <div class="meta">Параметры (опционально)</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;">
              <input id="presetInterfaceName" placeholder="Интерфейс (например, eth0)" value="${(lastPresetPreview?.config?.interfaces?.[0]?.name) || ''}" />
              <input id="presetInterfaceIP" placeholder="LAN CIDR (например, 192.168.10.1/24)" value="${(lastPresetPreview?.config?.interfaces?.[0]?.ip) || ''}" />
              <input id="presetGateway" placeholder="Шлюз (например, 192.168.10.254)" value="${(lastPresetPreview?.config?.routes?.[0]?.gateway) || ''}" />
            </div>
          </div>
          <div class="preset-summary" style="margin-top:8px;">
            <table>
              <thead><tr><th>Раздел</th><th>Было</th><th>Станет</th></tr></thead>
              <tbody>
                <tr><td>Маршруты</td><td>${summary.routes_before}</td><td>${summary.routes_after}</td></tr>
                <tr><td>Firewall</td><td>${summary.firewall_rules_before}</td><td>${summary.firewall_rules_after}</td></tr>
                <tr><td>NAT</td><td>${summary.nat_rules_before}</td><td>${summary.nat_rules_after}</td></tr>
                <tr><td>QoS</td><td>${summary.qos_classes_before}</td><td>${summary.qos_classes_after}</td></tr>
              </tbody>
            </table>
          </div>
          <div style="margin-top:8px;">${extrasList}</div>
          <div style="margin-top:12px;">
            <div class="meta">Сохранить как новый пресет</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;">
              <input id="presetIdInput" placeholder="id (latin/цифры/-/_)" />
              <input id="presetNameInput" placeholder="Название" />
              <button id="savePresetBtn">Сохранить</button>
            </div>
          </div>
        `;
        document.getElementById('savePresetBtn').addEventListener('click', saveCustomPresetFromPreview);
      }

      async function showPresetSummary(id) {
        selectedPresetId = id;
        try {
          const data = await previewPreset(id);
          lastPresetPreview = data;
          renderPresetDetail(data.preset, data.summary);
        } catch (e) {
          lastPresetPreview = null;
          renderPresetDetail(null, null, e.message);
        }
      }

      async function confirmApplyPreset(id) {
        try {
          const data = await previewPreset(id);
          const ok = confirm(`Применить пресет "${data.preset.name}"?`);
          if (!ok) {
            return;
          }
          await applyPreset(id);
          lastPresetPreview = data;
          renderPresetDetail(data.preset, data.summary);
          alert('Пресет применён');
        } catch (e) {
          alert(e.message);
        }
      }

      function buildPresetFromConfig(config) {
        return {
          settings: {
            interfaces: config.interfaces || [],
            routes: config.routes || [],
            firewall_defaults: config.firewall_defaults || {},
            firewall: config.firewall || [],
            nat: config.nat || [],
            qos: config.qos || [],
            ids: config.ids || {}
          }
        };
      }

      async function saveCustomPresetFromPreview() {
        if (!lastPresetPreview || !lastPresetPreview.config) {
          alert('Сначала выберите пресет и получите сводку');
          return;
        }
        const id = document.getElementById('presetIdInput').value.trim();
        const name = document.getElementById('presetNameInput').value.trim();
        if (!id || !name) {
          alert('Укажите id и название');
          return;
        }
        try {
          const base = buildPresetFromConfig(lastPresetPreview.config);
          base.id = id;
          base.name = name;
          base.description = 'Пользовательский пресет';
          await savePreset(base);
          presetsList = await loadPresets();
          renderPresets(presetsList);
          alert('Пресет сохранён');
        } catch (e) {
          alert(e.message);
        }
      }

      async function apiGet(url) {
        const res = await fetch(url);
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Ошибка запроса');
        }
        return res.json();
      }

      async function apiPost(url, payload) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Ошибка запроса');
        }
        return res.json().catch(() => ({}));
      }

      async function apiDelete(url, payload) {
        const res = await fetch(url, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Ошибка запроса');
        }
        return res.json().catch(() => ({}));
      }

      async function apiPut(url, payload) {
        const res = await fetch(url, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Ошибка запроса');
        }
        return res.json().catch(() => ({}));
      }

      async function downloadConfig(format) {
        const res = await fetch(`/api/config/export?format=${format}`);
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || 'Ошибка экспорта');
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `routergo-config.${format === 'yaml' ? 'yaml' : 'json'}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }

      async function loadRoutes() {
        return apiGet('/api/routes');
      }

      async function loadFirewall() {
        return apiGet('/api/firewall');
      }

      async function loadFirewallDefaults() {
        return apiGet('/api/firewall/defaults');
      }

      async function loadNAT() {
        return apiGet('/api/nat');
      }

      async function loadQoS() {
        return apiGet('/api/qos');
      }

      async function loadInterfaces() {
        return apiGet('/api/interfaces');
      }

      function renderEmptyRow(tbody, cols, text) {
        tbody.innerHTML = `<tr><td colspan="${cols}" class="muted">${text}</td></tr>`;
      }

      function renderRoutes(routes) {
        const tbody = document.querySelector('#routesTable tbody');
        if (!routes || routes.length === 0) {
          renderEmptyRow(tbody, 5, 'Маршруты не найдены');
          return;
        }
        tbody.innerHTML = routes.map(r => `
          <tr>
            <td>${r.destination || ''}</td>
            <td>${r.gateway || ''}</td>
            <td>${r.interface || ''}</td>
            <td>${r.metric ?? ''}</td>
            <td>
              <button class="route-edit" data-destination="${r.destination || ''}" data-gateway="${r.gateway || ''}" data-interface="${r.interface || ''}" data-metric="${r.metric ?? 0}">Редактировать</button>
              <button class="route-delete" data-destination="${r.destination || ''}" data-gateway="${r.gateway || ''}" data-interface="${r.interface || ''}" data-metric="${r.metric ?? 0}">Удалить</button>
            </td>
          </tr>
        `).join('');
      }

      function renderFirewall(rules) {
        const tbody = document.querySelector('#firewallTable tbody');
        if (!rules || rules.length === 0) {
          renderEmptyRow(tbody, 8, 'Правила не найдены');
          return;
        }
        tbody.innerHTML = rules.map(r => {
          const ports = [r.src_port ? `src:${r.src_port}` : '', r.dst_port ? `dst:${r.dst_port}` : ''].filter(Boolean).join(' ');
          const ifaces = [r.in_interface || '', r.out_interface || ''].filter(Boolean).join(' → ');
          return `
            <tr>
              <td>${r.chain || ''}</td>
              <td>${r.action || ''}</td>
              <td>${r.protocol || ''}</td>
              <td>${r.src_ip || ''}</td>
              <td>${r.dst_ip || ''}</td>
              <td>${ports}</td>
              <td>${ifaces}</td>
              <td>
                <button class="fw-delete"
                  data-chain="${r.chain || ''}"
                  data-action="${r.action || ''}"
                  data-protocol="${r.protocol || ''}"
                  data-src-ip="${r.src_ip || ''}"
                  data-dst-ip="${r.dst_ip || ''}"
                  data-src-port="${r.src_port ?? 0}"
                  data-dst-port="${r.dst_port ?? 0}"
                  data-in-interface="${r.in_interface || ''}"
                  data-out-interface="${r.out_interface || ''}"
                >Удалить</button>
                <button class="fw-edit"
                  data-chain="${r.chain || ''}"
                  data-action="${r.action || ''}"
                  data-protocol="${r.protocol || ''}"
                  data-src-ip="${r.src_ip || ''}"
                  data-dst-ip="${r.dst_ip || ''}"
                  data-src-port="${r.src_port ?? 0}"
                  data-dst-port="${r.dst_port ?? 0}"
                  data-in-interface="${r.in_interface || ''}"
                  data-out-interface="${r.out_interface || ''}"
                >Редактировать</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      function renderNAT(rules) {
        const tbody = document.querySelector('#natTable tbody');
        if (!rules || rules.length === 0) {
          renderEmptyRow(tbody, 6, 'Правила не найдены');
          return;
        }
        tbody.innerHTML = rules.map(r => {
          const ports = [r.src_port ? `src:${r.src_port}` : '', r.dst_port ? `dst:${r.dst_port}` : ''].filter(Boolean).join(' ');
          const to = [r.to_ip || '', r.to_port ? `:${r.to_port}` : ''].join('');
          return `
            <tr>
              <td>${r.type || ''}</td>
              <td>${r.src_ip || ''}</td>
              <td>${r.dst_ip || ''}</td>
              <td>${ports}</td>
              <td>${to}</td>
              <td>
                <button class="nat-delete"
                  data-type="${r.type || ''}"
                  data-src-ip="${r.src_ip || ''}"
                  data-dst-ip="${r.dst_ip || ''}"
                  data-src-port="${r.src_port ?? 0}"
                  data-dst-port="${r.dst_port ?? 0}"
                  data-to-ip="${r.to_ip || ''}"
                  data-to-port="${r.to_port ?? 0}"
                >Удалить</button>
                <button class="nat-edit"
                  data-type="${r.type || ''}"
                  data-src-ip="${r.src_ip || ''}"
                  data-dst-ip="${r.dst_ip || ''}"
                  data-src-port="${r.src_port ?? 0}"
                  data-dst-port="${r.dst_port ?? 0}"
                  data-to-ip="${r.to_ip || ''}"
                  data-to-port="${r.to_port ?? 0}"
                >Редактировать</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      function renderQoS(classes) {
        const tbody = document.querySelector('#qosTable tbody');
        if (!classes || classes.length === 0) {
          renderEmptyRow(tbody, 8, 'Классы не найдены');
          return;
        }
        tbody.innerHTML = classes.map(c => {
          const ports = [c.src_port ? `src:${c.src_port}` : '', c.dst_port ? `dst:${c.dst_port}` : ''].filter(Boolean).join(' ');
          return `
            <tr>
              <td>${c.name || ''}</td>
              <td>${c.protocol || ''}</td>
              <td>${ports}</td>
              <td>${c.rate_limit_kbps ?? ''}</td>
              <td>${c.priority ?? ''}</td>
              <td>${c.max_queue ?? ''}</td>
              <td>${c.drop_policy || ''}</td>
              <td>
                <button class="qos-delete" data-name="${c.name || ''}">Удалить</button>
                <button class="qos-edit"
                  data-name="${c.name || ''}"
                  data-protocol="${c.protocol || ''}"
                  data-src-port="${c.src_port ?? 0}"
                  data-dst-port="${c.dst_port ?? 0}"
                  data-rate="${c.rate_limit_kbps ?? 0}"
                  data-priority="${c.priority ?? 0}"
                  data-max-queue="${c.max_queue ?? 0}"
                  data-drop-policy="${c.drop_policy || ''}"
                >Редактировать</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      function renderInterfaces(interfaces) {
        const tbody = document.querySelector('#interfacesTable tbody');
        if (!interfaces || interfaces.length === 0) {
          renderEmptyRow(tbody, 3, 'Данные недоступны');
          return;
        }
        tbody.innerHTML = interfaces.map(i => `
          <tr>
            <td>${i.name || ''}</td>
            <td>${i.ip || ''}</td>
            <td>${i.state || ''}</td>
          </tr>
        `).join('');
      }

      async function refreshSettings() {
        try {
          const [routes, firewall, nat, qos, defaults, interfaces] = await Promise.all([
            loadRoutes(),
            loadFirewall(),
            loadNAT(),
            loadQoS(),
            loadFirewallDefaults(),
            loadInterfaces()
          ]);
          renderRoutes(routes);
          renderFirewall(firewall);
          renderNAT(nat);
          renderQoS(qos);
          renderInterfaces(interfaces);
          if (defaults) {
            const chain = document.getElementById('fwDefaultChain').value;
            if (defaults[chain]) {
              document.getElementById('fwDefaultAction').value = defaults[chain];
            }
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function refreshAll() {
        try {
          const [top, sessions, alerts, stats, proxyStats] = await Promise.all([
            loadTop(),
            loadSessions(),
            loadAlerts(),
            loadStats(),
            loadProxyStats()
          ]);
          renderTop(top);
          updateFilterOptions(top);
          renderHistory(top);
          renderSessions(sessions);
          renderAlerts(alerts);
          renderStats(stats);
          renderProxyStats(proxyStats);
          const enrichIP = document.getElementById('srcFilter').value || (top[0] ? top[0].src_ip : '');
          const enrich = await loadEnrich(enrichIP);
          renderEnrich(enrich);
        } catch (e) {
          console.error(e);
        }
      }

      function saveSettings() {
        const data = {
          demoMode: document.getElementById('demoMode').checked,
          refreshInterval: document.getElementById('refreshInterval').value,
          srcFilter: document.getElementById('srcFilter').value,
          alertType: document.getElementById('alertType').value,
          tab: document.querySelector('.nav button.active')?.dataset.tab || 'overview'
        };
        localStorage.setItem(storageKey, JSON.stringify(data));
      }

      function loadSettings() {
        const data = JSON.parse(localStorage.getItem(storageKey) || '{}');
        if (typeof data.demoMode === 'boolean') {
          document.getElementById('demoMode').checked = data.demoMode;
        }
        if (data.refreshInterval) {
          document.getElementById('refreshInterval').value = data.refreshInterval;
        }
        if (data.srcFilter) {
          document.getElementById('srcFilter').value = data.srcFilter;
        }
        if (data.alertType) {
          document.getElementById('alertType').value = data.alertType;
        }
        if (data.tab) {
          setTab(data.tab);
        } else {
          setTab('overview');
        }
      }

      function setTab(tab) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        const active = document.getElementById(`tab-${tab}`);
        if (active) {
          active.classList.remove('hidden');
        }
        document.querySelectorAll('.nav button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tab);
        });
        if (tab === 'settings') {
          refreshSettings();
        }
      }

      document.querySelectorAll('.nav button').forEach(btn => {
        btn.addEventListener('click', () => {
          setTab(btn.dataset.tab);
          saveSettings();
        });
      });
      document.getElementById('openPresetsBtn').addEventListener('click', () => {
        setTab('presets');
        saveSettings();
      });
      document.getElementById('updatePresetsBtn').addEventListener('click', async () => {
        try {
          const res = await updatePresets();
          presetsList = await loadPresets();
          renderPresets(presetsList);
          alert(`Обновлено пресетов: ${res.updated || 0}`);
        } catch (e) {
          alert(e.message);
        }
      });
      document.getElementById('importPresetsBtn').addEventListener('click', async () => {
        const raw = document.getElementById('presetsImport').value.trim();
        if (!raw) {
          alert('Вставьте JSON массив пресетов');
          return;
        }
        try {
          await importPresets(raw);
          presetsList = await loadPresets();
          renderPresets(presetsList);
          alert('Импорт завершён');
        } catch (e) {
          alert(e.message);
        }
      });

      function readNumber(id) {
        const raw = document.getElementById(id).value.trim();
        if (!raw) {
          return 0;
        }
        const parsed = parseInt(raw, 10);
        return Number.isNaN(parsed) ? 0 : parsed;
      }

      document.getElementById('addRouteBtn').addEventListener('click', async () => {
        const destination = document.getElementById('routeDestination').value.trim();
        const gateway = document.getElementById('routeGateway').value.trim();
        const iface = document.getElementById('routeInterface').value.trim();
        const metric = readNumber('routeMetric');
        if (!destination) {
          alert('Укажите destination (CIDR)');
          return;
        }
        try {
          await apiPost('/api/routes', {
            destination: destination,
            gateway: gateway,
            interface: iface,
            metric: metric
          });
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      let editingRoute = null;
      function setRouteEditState(state) {
        editingRoute = state;
        const updateBtn = document.getElementById('updateRouteBtn');
        const cancelBtn = document.getElementById('cancelRouteEditBtn');
        updateBtn.disabled = !editingRoute;
        cancelBtn.disabled = !editingRoute;
      }

      function fillRouteForm(route) {
        document.getElementById('routeDestination').value = route.destination || '';
        document.getElementById('routeGateway').value = route.gateway || '';
        document.getElementById('routeInterface').value = route.interface || '';
        document.getElementById('routeMetric').value = route.metric ?? '';
      }

      document.getElementById('updateRouteBtn').addEventListener('click', async () => {
        if (!editingRoute) {
          return;
        }
        const destination = document.getElementById('routeDestination').value.trim();
        const gateway = document.getElementById('routeGateway').value.trim();
        const iface = document.getElementById('routeInterface').value.trim();
        const metric = readNumber('routeMetric');
        if (!destination) {
          alert('Укажите destination (CIDR)');
          return;
        }
        try {
          await apiPut('/api/routes', {
            old_destination: editingRoute.destination,
            old_gateway: editingRoute.gateway,
            old_interface: editingRoute.interface,
            old_metric: editingRoute.metric,
            destination: destination,
            gateway: gateway,
            interface: iface,
            metric: metric
          });
          setRouteEditState(null);
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      document.getElementById('cancelRouteEditBtn').addEventListener('click', () => {
        setRouteEditState(null);
        fillRouteForm({ destination: '', gateway: '', interface: '', metric: '' });
      });

      document.getElementById('addFirewallBtn').addEventListener('click', async () => {
        try {
          await apiPost('/api/firewall', {
            chain: document.getElementById('fwChain').value,
            action: document.getElementById('fwAction').value,
            protocol: document.getElementById('fwProtocol').value.trim(),
            src_ip: document.getElementById('fwSrcIP').value.trim(),
            dst_ip: document.getElementById('fwDstIP').value.trim(),
            src_port: readNumber('fwSrcPort'),
            dst_port: readNumber('fwDstPort'),
            in_interface: document.getElementById('fwInIface').value.trim(),
            out_interface: document.getElementById('fwOutIface').value.trim()
          });
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      let editingFirewall = null;
      function setFirewallEditState(state) {
        editingFirewall = state;
        document.getElementById('updateFirewallBtn').disabled = !editingFirewall;
        document.getElementById('cancelFirewallEditBtn').disabled = !editingFirewall;
      }

      function fillFirewallForm(rule) {
        document.getElementById('fwChain').value = rule.chain || 'INPUT';
        document.getElementById('fwAction').value = rule.action || 'ACCEPT';
        document.getElementById('fwProtocol').value = rule.protocol || '';
        document.getElementById('fwSrcIP').value = rule.src_ip || '';
        document.getElementById('fwDstIP').value = rule.dst_ip || '';
        document.getElementById('fwSrcPort').value = rule.src_port ?? '';
        document.getElementById('fwDstPort').value = rule.dst_port ?? '';
        document.getElementById('fwInIface').value = rule.in_interface || '';
        document.getElementById('fwOutIface').value = rule.out_interface || '';
      }

      document.getElementById('updateFirewallBtn').addEventListener('click', async () => {
        if (!editingFirewall) {
          return;
        }
        try {
          await apiPut('/api/firewall', {
            old_chain: editingFirewall.chain,
            old_action: editingFirewall.action,
            old_protocol: editingFirewall.protocol,
            old_src_ip: editingFirewall.src_ip,
            old_dst_ip: editingFirewall.dst_ip,
            old_src_port: editingFirewall.src_port,
            old_dst_port: editingFirewall.dst_port,
            old_in_interface: editingFirewall.in_interface,
            old_out_interface: editingFirewall.out_interface,
            chain: document.getElementById('fwChain').value,
            action: document.getElementById('fwAction').value,
            protocol: document.getElementById('fwProtocol').value.trim(),
            src_ip: document.getElementById('fwSrcIP').value.trim(),
            dst_ip: document.getElementById('fwDstIP').value.trim(),
            src_port: readNumber('fwSrcPort'),
            dst_port: readNumber('fwDstPort'),
            in_interface: document.getElementById('fwInIface').value.trim(),
            out_interface: document.getElementById('fwOutIface').value.trim()
          });
          setFirewallEditState(null);
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      document.getElementById('cancelFirewallEditBtn').addEventListener('click', () => {
        setFirewallEditState(null);
        fillFirewallForm({
          chain: 'INPUT',
          action: 'ACCEPT',
          protocol: '',
          src_ip: '',
          dst_ip: '',
          src_port: '',
          dst_port: '',
          in_interface: '',
          out_interface: ''
        });
      });

      document.getElementById('firewallTable').addEventListener('click', async (event) => {
        const target = event.target;
        if (target.classList.contains('fw-edit')) {
          const rule = {
            chain: target.dataset.chain || '',
            action: target.dataset.action || '',
            protocol: target.dataset.protocol || '',
            src_ip: target.dataset.srcIp || '',
            dst_ip: target.dataset.dstIp || '',
            src_port: parseInt(target.dataset.srcPort || '0', 10) || 0,
            dst_port: parseInt(target.dataset.dstPort || '0', 10) || 0,
            in_interface: target.dataset.inInterface || '',
            out_interface: target.dataset.outInterface || ''
          };
          setFirewallEditState(rule);
          fillFirewallForm(rule);
          return;
        }
        if (!target.classList.contains('fw-delete')) {
          return;
        }
        if (!confirm('Удалить правило firewall?')) {
          return;
        }
        try {
          await apiDelete('/api/firewall', {
            chain: target.dataset.chain || '',
            action: target.dataset.action || '',
            protocol: target.dataset.protocol || '',
            src_ip: target.dataset.srcIp || '',
            dst_ip: target.dataset.dstIp || '',
            src_port: parseInt(target.dataset.srcPort || '0', 10) || 0,
            dst_port: parseInt(target.dataset.dstPort || '0', 10) || 0,
            in_interface: target.dataset.inInterface || '',
            out_interface: target.dataset.outInterface || ''
          });
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      document.getElementById('setFirewallDefaultBtn').addEventListener('click', async () => {
        try {
          await apiPost('/api/firewall/defaults', {
            chain: document.getElementById('fwDefaultChain').value,
            action: document.getElementById('fwDefaultAction').value
          });
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      document.getElementById('addNATBtn').addEventListener('click', async () => {
        try {
          await apiPost('/api/nat', {
            type: document.getElementById('natType').value,
            src_ip: document.getElementById('natSrcIP').value.trim(),
            dst_ip: document.getElementById('natDstIP').value.trim(),
            src_port: readNumber('natSrcPort'),
            dst_port: readNumber('natDstPort'),
            to_ip: document.getElementById('natToIP').value.trim(),
            to_port: readNumber('natToPort')
          });
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      let editingNAT = null;
      function setNATEditState(state) {
        editingNAT = state;
        document.getElementById('updateNATBtn').disabled = !editingNAT;
        document.getElementById('cancelNATEditBtn').disabled = !editingNAT;
      }

      function fillNATForm(rule) {
        document.getElementById('natType').value = rule.type || 'SNAT';
        document.getElementById('natSrcIP').value = rule.src_ip || '';
        document.getElementById('natDstIP').value = rule.dst_ip || '';
        document.getElementById('natSrcPort').value = rule.src_port ?? '';
        document.getElementById('natDstPort').value = rule.dst_port ?? '';
        document.getElementById('natToIP').value = rule.to_ip || '';
        document.getElementById('natToPort').value = rule.to_port ?? '';
      }

      document.getElementById('updateNATBtn').addEventListener('click', async () => {
        if (!editingNAT) {
          return;
        }
        try {
          await apiPut('/api/nat', {
            old_type: editingNAT.type,
            old_src_ip: editingNAT.src_ip,
            old_dst_ip: editingNAT.dst_ip,
            old_src_port: editingNAT.src_port,
            old_dst_port: editingNAT.dst_port,
            old_to_ip: editingNAT.to_ip,
            old_to_port: editingNAT.to_port,
            type: document.getElementById('natType').value,
            src_ip: document.getElementById('natSrcIP').value.trim(),
            dst_ip: document.getElementById('natDstIP').value.trim(),
            src_port: readNumber('natSrcPort'),
            dst_port: readNumber('natDstPort'),
            to_ip: document.getElementById('natToIP').value.trim(),
            to_port: readNumber('natToPort')
          });
          setNATEditState(null);
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      document.getElementById('cancelNATEditBtn').addEventListener('click', () => {
        setNATEditState(null);
        fillNATForm({
          type: 'SNAT',
          src_ip: '',
          dst_ip: '',
          src_port: '',
          dst_port: '',
          to_ip: '',
          to_port: ''
        });
      });

      document.getElementById('addQoSBtn').addEventListener('click', async () => {
        const name = document.getElementById('qosName').value.trim();
        if (!name) {
          alert('Укажите имя класса');
          return;
        }
        try {
          await apiPost('/api/qos', {
            name: name,
            protocol: document.getElementById('qosProtocol').value.trim(),
            src_port: readNumber('qosSrcPort'),
            dst_port: readNumber('qosDstPort'),
            rate_limit_kbps: readNumber('qosRate'),
            priority: readNumber('qosPriority'),
            max_queue: readNumber('qosMaxQueue'),
            drop_policy: document.getElementById('qosDropPolicy').value.trim()
          });
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      let editingQoS = null;
      function setQoSEditState(state) {
        editingQoS = state;
        document.getElementById('updateQoSBtn').disabled = !editingQoS;
        document.getElementById('cancelQoSEditBtn').disabled = !editingQoS;
      }

      function fillQoSForm(cl) {
        document.getElementById('qosName').value = cl.name || '';
        document.getElementById('qosProtocol').value = cl.protocol || '';
        document.getElementById('qosSrcPort').value = cl.src_port ?? '';
        document.getElementById('qosDstPort').value = cl.dst_port ?? '';
        document.getElementById('qosRate').value = cl.rate_limit_kbps ?? '';
        document.getElementById('qosPriority').value = cl.priority ?? '';
        document.getElementById('qosMaxQueue').value = cl.max_queue ?? '';
        document.getElementById('qosDropPolicy').value = cl.drop_policy || '';
      }

      document.getElementById('updateQoSBtn').addEventListener('click', async () => {
        if (!editingQoS) {
          return;
        }
        const name = document.getElementById('qosName').value.trim();
        if (!name) {
          alert('Укажите имя класса');
          return;
        }
        try {
          await apiPut('/api/qos', {
            old_name: editingQoS.name,
            name: name,
            protocol: document.getElementById('qosProtocol').value.trim(),
            src_port: readNumber('qosSrcPort'),
            dst_port: readNumber('qosDstPort'),
            rate_limit_kbps: readNumber('qosRate'),
            priority: readNumber('qosPriority'),
            max_queue: readNumber('qosMaxQueue'),
            drop_policy: document.getElementById('qosDropPolicy').value.trim()
          });
          setQoSEditState(null);
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      document.getElementById('cancelQoSEditBtn').addEventListener('click', () => {
        setQoSEditState(null);
        fillQoSForm({
          name: '',
          protocol: '',
          src_port: '',
          dst_port: '',
          rate_limit_kbps: '',
          priority: '',
          max_queue: '',
          drop_policy: ''
        });
      });

      document.getElementById('qosTable').addEventListener('click', async (event) => {
        const target = event.target;
        if (target.classList.contains('qos-edit')) {
          const cl = {
            name: target.dataset.name || '',
            protocol: target.dataset.protocol || '',
            src_port: parseInt(target.dataset.srcPort || '0', 10) || 0,
            dst_port: parseInt(target.dataset.dstPort || '0', 10) || 0,
            rate_limit_kbps: parseInt(target.dataset.rate || '0', 10) || 0,
            priority: parseInt(target.dataset.priority || '0', 10) || 0,
            max_queue: parseInt(target.dataset.maxQueue || '0', 10) || 0,
            drop_policy: target.dataset.dropPolicy || ''
          };
          setQoSEditState(cl);
          fillQoSForm(cl);
          return;
        }
        if (!target.classList.contains('qos-delete')) {
          return;
        }
        if (!confirm('Удалить класс QoS?')) {
          return;
        }
        try {
          await apiDelete('/api/qos', { name: target.dataset.name || '' });
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      document.getElementById('exportConfigJsonBtn').addEventListener('click', async () => {
        try {
          await downloadConfig('json');
        } catch (e) {
          alert(e.message);
        }
      });

      document.getElementById('exportConfigYamlBtn').addEventListener('click', async () => {
        try {
          await downloadConfig('yaml');
        } catch (e) {
          alert(e.message);
        }
      });

      document.getElementById('natTable').addEventListener('click', async (event) => {
        const target = event.target;
        if (target.classList.contains('nat-edit')) {
          const rule = {
            type: target.dataset.type || '',
            src_ip: target.dataset.srcIp || '',
            dst_ip: target.dataset.dstIp || '',
            src_port: parseInt(target.dataset.srcPort || '0', 10) || 0,
            dst_port: parseInt(target.dataset.dstPort || '0', 10) || 0,
            to_ip: target.dataset.toIp || '',
            to_port: parseInt(target.dataset.toPort || '0', 10) || 0
          };
          setNATEditState(rule);
          fillNATForm(rule);
          return;
        }
        if (!target.classList.contains('nat-delete')) {
          return;
        }
        if (!confirm('Удалить правило NAT?')) {
          return;
        }
        try {
          await apiDelete('/api/nat', {
            type: target.dataset.type || '',
            src_ip: target.dataset.srcIp || '',
            dst_ip: target.dataset.dstIp || '',
            src_port: parseInt(target.dataset.srcPort || '0', 10) || 0,
            dst_port: parseInt(target.dataset.dstPort || '0', 10) || 0,
            to_ip: target.dataset.toIp || '',
            to_port: parseInt(target.dataset.toPort || '0', 10) || 0
          });
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      document.getElementById('routesTable').addEventListener('click', async (event) => {
        const target = event.target;
        if (target.classList.contains('route-edit')) {
          const route = {
            destination: target.dataset.destination || '',
            gateway: target.dataset.gateway || '',
            interface: target.dataset.interface || '',
            metric: parseInt(target.dataset.metric || '0', 10) || 0
          };
          setRouteEditState(route);
          fillRouteForm(route);
          return;
        }
        if (!target.classList.contains('route-delete')) {
          return;
        }
        const destination = target.dataset.destination || '';
        if (!destination) {
          return;
        }
        if (!confirm('Удалить маршрут?')) {
          return;
        }
        try {
          await apiDelete('/api/routes', {
            destination: destination,
            gateway: target.dataset.gateway || '',
            interface: target.dataset.interface || '',
            metric: parseInt(target.dataset.metric || '0', 10) || 0
          });
          await refreshSettings();
        } catch (e) {
          alert(e.message);
        }
      });

      loadSettings();
      refreshAll();
      loadPresets().then(list => {
        presetsList = list;
        renderPresets(list);
      }).catch(() => {
        renderPresets([]);
      });
      function startTimer() {
        if (refreshTimer) {
          clearInterval(refreshTimer);
        }
        const interval = parseInt(document.getElementById('refreshInterval').value, 10);
        refreshTimer = setInterval(refreshAll, interval);
        saveSettings();
      }
      startTimer();
      document.getElementById('refreshBtn').addEventListener('click', refreshAll);
      document.getElementById('refreshInterval').addEventListener('change', startTimer);
      document.getElementById('srcFilter').addEventListener('change', () => { saveSettings(); refreshAll(); });
      document.getElementById('demoMode').addEventListener('change', () => { saveSettings(); refreshAll(); });
      document.getElementById('alertType').addEventListener('change', () => { saveSettings(); refreshAll(); });
    </script>
  </body>
</html>
