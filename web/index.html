<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <title>RouterGo Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; background: #f6f7fb; color: #1d1f23; }
      h1 { margin-bottom: 6px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
      .gridWide { grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); }
      .card { background: #fff; border-radius: 10px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
      .meta { font-size: 12px; color: #6b7280; }
      .alerts { max-height: 220px; overflow: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 12px; }
      th, td { padding: 6px; border-bottom: 1px solid #eee; text-align: left; }
      .badge { display: inline-block; padding: 2px 6px; border-radius: 6px; font-size: 11px; background: #eef2ff; color: #3730a3; }
      .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background:#f3f4f6; font-size: 12px; margin-right: 6px; }
      .nav { display:flex; gap:8px; flex-wrap: wrap; margin: 8px 0; }
      .nav button { padding: 6px 10px; border-radius: 8px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
      .nav button.active { background:#eef2ff; border-color:#c7d2fe; }
      .hidden { display: none; }
      .preset-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
      .preset-card { background:#fff; border-radius: 10px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
      .preset-icon { font-size: 28px; }
      .preset-actions { display:flex; gap:8px; margin-top: 8px; }
      .preset-summary table { font-size: 12px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div style="display:flex; align-items:center; gap:12px; flex-wrap: wrap;">
      <h1 style="margin-right:auto;">RouterGo Dashboard</h1>
      <button id="openPresetsBtn">Настроить по шаблону</button>
    </div>
    <div class="meta">Автообновление</div>
    <div class="nav">
      <button data-tab="overview">Обзор</button>
      <button data-tab="traffic">Трафик</button>
      <button data-tab="sessions">Сессии</button>
      <button data-tab="alerts">Алерты</button>
      <button data-tab="presets">Пресеты</button>
    </div>
    <div style="margin: 10px 0; display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
      <button id="refreshBtn">Обновить сейчас</button>
      <label>
        <input type="checkbox" id="demoMode"> Демо-данные
      </label>
      <label>
        Интервал:
        <select id="refreshInterval">
          <option value="2000">2с</option>
          <option value="5000" selected>5с</option>
          <option value="10000">10с</option>
        </select>
      </label>
      <label>
        Фильтр src:
        <select id="srcFilter">
          <option value="">Все</option>
        </select>
      </label>
    </div>
    <div id="tab-overview" class="grid gridWide" style="margin-top: 12px;">
      <div class="card">
        <h3>Система</h3>
        <div id="sysStats">
          <span class="pill">packets: -</span>
          <span class="pill">rx: -</span>
          <span class="pill">tx: -</span>
          <span class="pill">drops: -</span>
          <span class="pill">errors: -</span>
        </div>
        <div class="meta" style="margin-top:8px;">/api/stats</div>
      </div>
      <div class="card">
        <h3>Подсистемы</h3>
        <div id="subsystemStats">
          <div class="pill">IDS alerts: -</div>
          <div class="pill">P2P peers: -</div>
          <div class="pill">Proxy hits: -</div>
        </div>
      </div>
      <div class="card">
        <h3>Proxy</h3>
        <div id="proxyStats">
          <span class="pill">hits: -</span>
          <span class="pill">miss: -</span>
          <span class="pill">compress: -</span>
          <span class="pill">size: -</span>
        </div>
      </div>
      <div class="card">
        <h3>Enrich</h3>
        <div id="enrichInfo" class="meta">Выберите src для обогащения</div>
      </div>
    </div>

    <div id="tab-traffic" class="grid" style="margin-top: 12px;">
      <div class="card">
        <h3>Top bandwidth (src IP)</h3>
        <canvas id="topChart" height="140"></canvas>
      </div>
      <div class="card">
        <h3>История трафика (top src)</h3>
        <canvas id="historyChart" height="140"></canvas>
      </div>
    </div>

    <div id="tab-sessions" class="grid" style="margin-top: 12px;">
      <div class="card">
        <h3>Sessions tree</h3>
        <div class="meta">Суммарные байты по направлению</div>
        <table id="sessionsTable">
          <thead>
            <tr><th>Src</th><th>Dst</th><th>Bytes</th><th>Packets</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="tab-alerts" class="grid" style="margin-top: 12px;">
      <div class="card">
        <h3>Alerts</h3>
        <div class="meta">Фильтры</div>
        <div style="margin: 6px 0;">
          <label>Тип:
            <select id="alertType">
              <option value="">Все</option>
              <option value="SIGNATURE">SIGNATURE</option>
              <option value="RATE_SPIKE">RATE_SPIKE</option>
              <option value="PORT_SCAN">PORT_SCAN</option>
              <option value="DST_SWEEP">DST_SWEEP</option>
            </select>
          </label>
        </div>
        <div class="alerts" id="alerts"></div>
      </div>
    </div>

    <div id="tab-presets" class="grid gridWide" style="margin-top: 12px;">
      <div class="card">
        <h3>Быстрая настройка → Пресеты</h3>
        <div class="meta">Выберите профиль и посмотрите сводку изменений.</div>
        <div id="presetsGrid" class="preset-grid" style="margin-top: 10px;"></div>
      </div>
      <div class="card">
        <h3>Сводка пресета</h3>
        <div id="presetDetail" class="meta">Выберите пресет</div>
      </div>
    </div>

    <script>
      const topCtx = document.getElementById('topChart');
      const historyCtx = document.getElementById('historyChart');
      let topChart = new Chart(topCtx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Bytes', data: [], backgroundColor: '#3b82f6' }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
      let historyChart = new Chart(historyCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Bytes', data: [], borderColor: '#10b981', fill: false, tension: 0.2 }] },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      let history = [];
      let refreshTimer = null;
      const storageKey = 'routergo_ui';
      let presetsList = [];
      let selectedPresetId = '';

      function demoTop() {
        const labels = Array.from({length: 8}, (_, i) => `10.0.0.${i+1}`);
        return labels.map((l, i) => ({ src_ip: l, bytes: (8 - i) * 1000 + Math.floor(Math.random()*800) }));
      }

      function demoSessions() {
        const data = {};
        for (let s = 1; s <= 4; s++) {
          const src = `10.0.0.${s}`;
          data[src] = [];
          for (let d = 1; d <= 3; d++) {
            data[src].push({ dst_ip: `1.1.1.${d}`, bytes: Math.floor(Math.random()*5000), packets: Math.floor(Math.random()*50) });
          }
        }
        return data;
      }

      function demoAlerts() {
        const now = new Date().toISOString();
        return [
          { type: 'PORT_SCAN', src_ip: '10.0.0.5', dst_ip: '1.1.1.1', reason: 'port_scan', protocol: 'TCP', timestamp: now },
          { type: 'RATE_SPIKE', src_ip: '10.0.0.8', dst_ip: '8.8.8.8', reason: 'rate_threshold', protocol: 'UDP', timestamp: now }
        ];
      }

      async function loadTop() {
        if (document.getElementById('demoMode').checked) {
          return demoTop();
        }
        const res = await fetch('/api/dashboard/top/bandwidth?limit=10');
        const data = await res.json();
        return data.length ? data : demoTop();
      }

      async function loadSessions() {
        if (document.getElementById('demoMode').checked) {
          return demoSessions();
        }
        const res = await fetch('/api/dashboard/sessions/tree');
        const data = await res.json();
        return Object.keys(data).length ? data : demoSessions();
      }

      async function loadAlerts() {
        if (document.getElementById('demoMode').checked) {
          return demoAlerts();
        }
        const type = document.getElementById('alertType').value;
        const url = type ? `/api/dashboard/alerts?type=${encodeURIComponent(type)}` : '/api/dashboard/alerts';
        const res = await fetch(url);
        const data = await res.json();
        return Array.isArray(data) && data.length ? data : demoAlerts();
      }

      async function loadStats() {
        const res = await fetch('/api/stats');
        if (!res.ok) {
          return null;
        }
        return res.json();
      }

      async function loadPresets() {
        const res = await fetch('/api/presets');
        if (!res.ok) {
          return [];
        }
        return res.json();
      }

      async function previewPreset(id) {
        const res = await fetch(`/api/presets/${encodeURIComponent(id)}/preview`, { method: 'POST' });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Не удалось получить сводку');
        }
        return res.json();
      }

      async function applyPreset(id) {
        const res = await fetch(`/api/presets/${encodeURIComponent(id)}/apply`, { method: 'POST' });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || 'Не удалось применить пресет');
        }
        return res.json();
      }

      async function loadProxyStats() {
        const res = await fetch('/api/proxy/stats');
        if (!res.ok) {
          return null;
        }
        return res.json();
      }

      async function loadEnrich(ip) {
        if (!ip) {
          return null;
        }
        const res = await fetch(`/api/enrich/ip?ip=${encodeURIComponent(ip)}`);
        if (!res.ok) {
          return null;
        }
        return res.json();
      }

      function renderTop(data) {
        topChart.data.labels = data.map(x => x.src_ip);
        topChart.data.datasets[0].data = data.map(x => x.bytes);
        topChart.update();
      }

      function renderHistory(topData) {
        if (!topData.length) {
          return;
        }
        const top = topData[0];
        const now = new Date().toLocaleTimeString();
        history.push({ t: now, v: top.bytes, src: top.src_ip });
        if (history.length > 30) {
          history = history.slice(-30);
        }
        historyChart.data.labels = history.map(h => h.t);
        historyChart.data.datasets[0].data = history.map(h => h.v);
        historyChart.update();
      }

      function renderSessions(data) {
        const rows = [];
        const filter = document.getElementById('srcFilter').value;
        Object.keys(data).forEach(src => {
          if (filter && src !== filter) {
            return;
          }
          data[src].forEach(dst => {
            rows.push({ src, dst: dst.dst_ip, bytes: dst.bytes, packets: dst.packets });
          });
        });
        rows.sort((a, b) => b.bytes - a.bytes);
        const tbody = document.querySelector('#sessionsTable tbody');
        tbody.innerHTML = rows.slice(0, 20).map(r =>
          `<tr><td>${r.src}</td><td>${r.dst}</td><td>${r.bytes}</td><td>${r.packets}</td></tr>`
        ).join('');
      }

      function renderAlerts(data) {
        const container = document.getElementById('alerts');
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = '<div class="meta">Нет алертов</div>';
          return;
        }
        container.innerHTML = data.slice(-50).reverse().map(a =>
          `<div style="margin-bottom:8px;">
            <span class="badge">${a.type || 'ALERT'}</span>
            <strong>${a.src_ip || '-'}</strong> → <strong>${a.dst_ip || '-'}</strong>
            <div class="meta">${a.reason || ''} ${a.protocol || ''} ${a.timestamp || ''}</div>
          </div>`
        ).join('');
      }

      function renderStats(stats) {
        if (!stats || stats.status !== 'ok') {
          return;
        }
        document.getElementById('sysStats').innerHTML = `
          <span class="pill">packets: ${stats.packets_total}</span>
          <span class="pill">rx: ${stats.rx_packets_total}</span>
          <span class="pill">tx: ${stats.tx_packets_total}</span>
          <span class="pill">drops: ${stats.drops_total}</span>
          <span class="pill">errors: ${stats.errors_total}</span>
        `;
        document.getElementById('subsystemStats').innerHTML = `
          <div class="pill">IDS alerts: ${stats.ids_alerts_total}</div>
          <div class="pill">P2P peers: ${stats.p2p_peers_total}</div>
          <div class="pill">Proxy hits: ${stats.proxy_cache_hits_total}</div>
        `;
      }

      function renderProxyStats(stats) {
        if (!stats) {
          return;
        }
        document.getElementById('proxyStats').innerHTML = `
          <span class="pill">hits: ${stats.cache_hits}</span>
          <span class="pill">miss: ${stats.cache_miss}</span>
          <span class="pill">compress: ${stats.compress_total}</span>
          <span class="pill">size: ${stats.cache_size}</span>
        `;
      }

      function renderEnrich(data) {
        const container = document.getElementById('enrichInfo');
        if (!data) {
          container.innerHTML = 'Нет данных';
          return;
        }
        const geo = data.geo ? `${data.geo.country || ''} ${data.geo.city || ''}`.trim() : '-';
        const asn = data.asn ? data.asn.asn || '-' : '-';
        const threat = data.threat ? data.threat.score : '-';
        container.innerHTML = `
          <div class="pill">IP: ${data.ip}</div>
          <div class="pill">Geo: ${geo || '-'}</div>
          <div class="pill">ASN: ${asn}</div>
          <div class="pill">Threat: ${threat}</div>
        `;
      }

      function updateFilterOptions(topData) {
        const select = document.getElementById('srcFilter');
        const current = select.value;
        const options = [''].concat(topData.map(x => x.src_ip));
        select.innerHTML = options.map(v => `<option value="${v}">${v || 'Все'}</option>`).join('');
        select.value = options.includes(current) ? current : '';
      }

      function renderPresets(list) {
        const grid = document.getElementById('presetsGrid');
        if (!Array.isArray(list) || list.length === 0) {
          grid.innerHTML = '<div class="meta">Пресеты не найдены</div>';
          return;
        }
        grid.innerHTML = list.map(p => `
          <div class="preset-card">
            <div class="preset-icon">${p.icon || '⚙️'}</div>
            <h3>${p.name}</h3>
            <div class="meta">${p.description || ''}</div>
            <div class="preset-actions">
              <button data-id="${p.id}" class="preset-preview">Сводка</button>
              <button data-id="${p.id}" class="preset-apply">Применить</button>
            </div>
          </div>
        `).join('');
        grid.querySelectorAll('.preset-preview').forEach(btn => {
          btn.addEventListener('click', () => showPresetSummary(btn.dataset.id));
        });
        grid.querySelectorAll('.preset-apply').forEach(btn => {
          btn.addEventListener('click', () => confirmApplyPreset(btn.dataset.id));
        });
      }

      function renderPresetDetail(preset, summary, error) {
        const detail = document.getElementById('presetDetail');
        if (error) {
          detail.innerHTML = `<div class="meta">${error}</div>`;
          return;
        }
        if (!preset || !summary) {
          detail.innerHTML = '<div class="meta">Выберите пресет</div>';
          return;
        }
        const extras = preset.extras || {};
        const extrasList = Object.keys(extras).map(k => `<div class="meta"><strong>${k}:</strong> ${Array.isArray(extras[k]) ? extras[k].join(', ') : extras[k]}</div>`).join('');
        detail.innerHTML = `
          <div><strong>${preset.name}</strong></div>
          <div class="meta">${preset.description || ''}</div>
          <div class="preset-summary" style="margin-top:8px;">
            <table>
              <thead><tr><th>Раздел</th><th>Было</th><th>Станет</th></tr></thead>
              <tbody>
                <tr><td>Маршруты</td><td>${summary.routes_before}</td><td>${summary.routes_after}</td></tr>
                <tr><td>Firewall</td><td>${summary.firewall_rules_before}</td><td>${summary.firewall_rules_after}</td></tr>
                <tr><td>NAT</td><td>${summary.nat_rules_before}</td><td>${summary.nat_rules_after}</td></tr>
                <tr><td>QoS</td><td>${summary.qos_classes_before}</td><td>${summary.qos_classes_after}</td></tr>
              </tbody>
            </table>
          </div>
          <div style="margin-top:8px;">${extrasList}</div>
        `;
      }

      async function showPresetSummary(id) {
        selectedPresetId = id;
        try {
          const data = await previewPreset(id);
          renderPresetDetail(data.preset, data.summary);
        } catch (e) {
          renderPresetDetail(null, null, e.message);
        }
      }

      async function confirmApplyPreset(id) {
        try {
          const data = await previewPreset(id);
          const ok = confirm(`Применить пресет "${data.preset.name}"?`);
          if (!ok) {
            return;
          }
          await applyPreset(id);
          renderPresetDetail(data.preset, data.summary);
          alert('Пресет применён');
        } catch (e) {
          alert(e.message);
        }
      }

      async function refreshAll() {
        try {
          const [top, sessions, alerts, stats, proxyStats] = await Promise.all([
            loadTop(),
            loadSessions(),
            loadAlerts(),
            loadStats(),
            loadProxyStats()
          ]);
          renderTop(top);
          updateFilterOptions(top);
          renderHistory(top);
          renderSessions(sessions);
          renderAlerts(alerts);
          renderStats(stats);
          renderProxyStats(proxyStats);
          const enrichIP = document.getElementById('srcFilter').value || (top[0] ? top[0].src_ip : '');
          const enrich = await loadEnrich(enrichIP);
          renderEnrich(enrich);
        } catch (e) {
          console.error(e);
        }
      }

      function saveSettings() {
        const data = {
          demoMode: document.getElementById('demoMode').checked,
          refreshInterval: document.getElementById('refreshInterval').value,
          srcFilter: document.getElementById('srcFilter').value,
          alertType: document.getElementById('alertType').value,
          tab: document.querySelector('.nav button.active')?.dataset.tab || 'overview'
        };
        localStorage.setItem(storageKey, JSON.stringify(data));
      }

      function loadSettings() {
        const data = JSON.parse(localStorage.getItem(storageKey) || '{}');
        if (typeof data.demoMode === 'boolean') {
          document.getElementById('demoMode').checked = data.demoMode;
        }
        if (data.refreshInterval) {
          document.getElementById('refreshInterval').value = data.refreshInterval;
        }
        if (data.srcFilter) {
          document.getElementById('srcFilter').value = data.srcFilter;
        }
        if (data.alertType) {
          document.getElementById('alertType').value = data.alertType;
        }
        if (data.tab) {
          setTab(data.tab);
        } else {
          setTab('overview');
        }
      }

      function setTab(tab) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        const active = document.getElementById(`tab-${tab}`);
        if (active) {
          active.classList.remove('hidden');
        }
        document.querySelectorAll('.nav button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tab);
        });
      }

      document.querySelectorAll('.nav button').forEach(btn => {
        btn.addEventListener('click', () => {
          setTab(btn.dataset.tab);
          saveSettings();
        });
      });
      document.getElementById('openPresetsBtn').addEventListener('click', () => {
        setTab('presets');
        saveSettings();
      });

      loadSettings();
      refreshAll();
      loadPresets().then(list => {
        presetsList = list;
        renderPresets(list);
      }).catch(() => {
        renderPresets([]);
      });
      function startTimer() {
        if (refreshTimer) {
          clearInterval(refreshTimer);
        }
        const interval = parseInt(document.getElementById('refreshInterval').value, 10);
        refreshTimer = setInterval(refreshAll, interval);
        saveSettings();
      }
      startTimer();
      document.getElementById('refreshBtn').addEventListener('click', refreshAll);
      document.getElementById('refreshInterval').addEventListener('change', startTimer);
      document.getElementById('srcFilter').addEventListener('change', () => { saveSettings(); refreshAll(); });
      document.getElementById('demoMode').addEventListener('change', () => { saveSettings(); refreshAll(); });
      document.getElementById('alertType').addEventListener('change', () => { saveSettings(); refreshAll(); });
    </script>
  </body>
</html>
